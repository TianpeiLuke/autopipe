{
  "script_name": "risk_table_mapping",
  "level1": {
    "passed": true,
    "issues": [
      {
        "severity": "INFO",
        "category": "arguments",
        "message": "Script defines config-driven argument provided by builder: --job-type (accessed as args.job_type)",
        "details": {
          "cli_argument": "job-type",
          "python_attribute": "job_type",
          "script": "risk_table_mapping",
          "source": "builder"
        },
        "recommendation": "Argument --job-type is provided by builder - no action needed"
      }
    ],
    "script_analysis": {
      "script_path": "/Users/tianpeixie/github_workspace/cursus/src/cursus/steps/scripts/risk_table_mapping.py",
      "path_references": [
        "path='\\nRisk Table Mapping Processing Script\\n\\nThis script creates and applies risk tables for categorical features based on \\ntarget variable correlation, and handles missing value imputation for numeric features.\\nIt supports both training mode (fit and transform) and inference mode (transform only).\\n' line_number=2 context='#!/usr/bin/env python\\n>>> \"\"\"\\nRisk Table Mapping Processing Script\\n' is_hardcoded=True construction_method=None",
        "path='bin_mapping.pkl' line_number=24 context='# These constants ensure the same filenames are used across all job types,\\n# facilitating proper connections between training and non-training steps\\n>>> RISK_TABLE_FILENAME = \"bin_mapping.pkl\"  # Used by downstream steps as input dependency\\nHYPERPARAMS_FILENAME = \"hyperparameters.json\"  # Expected by the script and generated by the builder\\n' is_hardcoded=True construction_method=None",
        "path='hyperparameters.json' line_number=25 context='# facilitating proper connections between training and non-training steps\\nRISK_TABLE_FILENAME = \"bin_mapping.pkl\"  # Used by downstream steps as input dependency\\n>>> HYPERPARAMS_FILENAME = \"hyperparameters.json\"  # Expected by the script and generated by the builder\\n\\n# Set up logging' is_hardcoded=True construction_method=None",
        "path='\\n    A class to create risk tables for categorical features.\\n    \\n    Risk tables map categorical values to numerical risk scores based on\\n    their correlation with the target variable.\\n    ' line_number=100 context='\\nclass OfflineBinning:\\n>>>     \"\"\"\\n    A class to create risk tables for categorical features.\\n    ' is_hardcoded=True construction_method=None",
        "path='Fits the risk tables based on the provided dataframe.' line_number=112 context='\\n    def fit(self, df: pd.DataFrame, smooth_factor: float = 0, count_threshold: int = 0):\\n>>>         \"\"\"Fits the risk tables based on the provided dataframe.\"\"\"\\n        # Drop any -1 or NaN target rows for fitting\\n        fit_df = df.loc[(df[self.target] != -1) & (~df[self.target].isnull())].copy()' is_hardcoded=True construction_method=None",
        "path='Helper to calculate the risk table for a single variable.' line_number=143 context='\\n    def _create_risk_table(self, df, variable, default_risk, samples, count_threshold):\\n>>>         \"\"\"Helper to calculate the risk table for a single variable.\"\"\"\\n        cross_tab = pd.crosstab(df[variable], df[self.target].astype(object), margins=True, margins_name=\"_count_\", dropna=False)\\n        cross_tab[\"risk\"] = cross_tab.apply(lambda x: x.get(1, 0.0) / (x.get(1, 0) + x.get(0, 0)), axis=1)' is_hardcoded=True construction_method=None",
        "path='Transforms the dataframe using the fitted risk tables.' line_number=154 context='\\n    def transform(self, df: pd.DataFrame) -> pd.DataFrame:\\n>>>         \"\"\"Transforms the dataframe using the fitted risk tables.\"\"\"\\n        df_transformed = df.copy()\\n        for var, risk_table_info in self.risk_tables.items():' is_hardcoded=True construction_method=None",
        "path='Loads pre-existing risk tables.' line_number=164 context='\\n    def load_risk_tables(self, risk_tables):\\n>>>         \"\"\"Loads pre-existing risk tables.\"\"\"\\n        self.risk_tables = risk_tables\\n        logger.info(f\"Loaded {len(risk_tables)} risk tables\")' is_hardcoded=True construction_method=None",
        "path='train_processed_data.csv' line_number=184 context='    if job_type == \"training\":\\n        # For training, we expect data in train/test/val subdirectories\\n>>>         train_df = pd.read_csv(input_path / \"train\" / \"train_processed_data.csv\")\\n        test_df = pd.read_csv(input_path / \"test\" / \"test_processed_data.csv\")\\n        val_df = pd.read_csv(input_path / \"val\" / \"val_processed_data.csv\")' is_hardcoded=True construction_method=None",
        "path='test_processed_data.csv' line_number=185 context='        # For training, we expect data in train/test/val subdirectories\\n        train_df = pd.read_csv(input_path / \"train\" / \"train_processed_data.csv\")\\n>>>         test_df = pd.read_csv(input_path / \"test\" / \"test_processed_data.csv\")\\n        val_df = pd.read_csv(input_path / \"val\" / \"val_processed_data.csv\")\\n        logger.info(f\"Loaded training data splits: train={train_df.shape}, test={test_df.shape}, val={val_df.shape}\")' is_hardcoded=True construction_method=None",
        "path='val_processed_data.csv' line_number=186 context='        train_df = pd.read_csv(input_path / \"train\" / \"train_processed_data.csv\")\\n        test_df = pd.read_csv(input_path / \"test\" / \"test_processed_data.csv\")\\n>>>         val_df = pd.read_csv(input_path / \"val\" / \"val_processed_data.csv\")\\n        logger.info(f\"Loaded training data splits: train={train_df.shape}, test={test_df.shape}, val={val_df.shape}\")\\n        return {\"train\": train_df, \"test\": test_df, \"val\": val_df}' is_hardcoded=True construction_method=None",
        "path='_processed_data.csv' line_number=191 context='    else:\\n        # For other job types, we expect data in a single directory named after job_type\\n>>>         df = pd.read_csv(input_path / job_type / f\"{job_type}_processed_data.csv\")\\n        logger.info(f\"Loaded {job_type} data: {df.shape}\")\\n        return {job_type: df}' is_hardcoded=True construction_method=None",
        "path='_processed_data.csv' line_number=209 context='        split_output_dir.mkdir(exist_ok=True, parents=True)\\n        \\n>>>         output_file = split_output_dir / f\"{split_name}_processed_data.csv\"\\n        df.to_csv(output_file, index=False)\\n        logger.info(f\"Saved {split_name} data to {output_file}, shape: {df.shape}\")' is_hardcoded=True construction_method=None",
        "path='No valid categorical fields found for risk mapping. Using original data.' line_number=244 context='        \\n        if not valid_cat_fields:\\n>>>             logger.warning(\"No valid categorical fields found for risk mapping. Using original data.\")\\n            transformed_data = data_dict\\n            ' is_hardcoded=True construction_method=None",
        "path='Risk-table mapping complete.' line_number=403 context='    save_artifacts(binner, hyperparams, output_path)\\n\\n>>>     logger.info(\"Risk-table mapping complete.\")\\n    return transformed_data, binner\\n' is_hardcoded=True construction_method=None",
        "path='/opt/ml/processing/input/data' line_number=416 context='        \\n        # Define standard SageMaker paths based on contract\\n>>>         input_dir = \"/opt/ml/processing/input/data\"\\n        config_dir = \"/opt/ml/processing/input/config\"\\n        output_dir = \"/opt/ml/processing/output\"' is_hardcoded=True construction_method=None",
        "path='/opt/ml/processing/input/config' line_number=417 context='        # Define standard SageMaker paths based on contract\\n        input_dir = \"/opt/ml/processing/input/data\"\\n>>>         config_dir = \"/opt/ml/processing/input/config\"\\n        output_dir = \"/opt/ml/processing/output\"\\n        risk_table_input_dir = \"/opt/ml/processing/input/risk_tables\" if args.job_type != \"training\" else None' is_hardcoded=True construction_method=None",
        "path='/opt/ml/processing/output' line_number=418 context='        input_dir = \"/opt/ml/processing/input/data\"\\n        config_dir = \"/opt/ml/processing/input/config\"\\n>>>         output_dir = \"/opt/ml/processing/output\"\\n        risk_table_input_dir = \"/opt/ml/processing/input/risk_tables\" if args.job_type != \"training\" else None\\n' is_hardcoded=True construction_method=None",
        "path='/opt/ml/processing/input/risk_tables' line_number=419 context='        config_dir = \"/opt/ml/processing/input/config\"\\n        output_dir = \"/opt/ml/processing/output\"\\n>>>         risk_table_input_dir = \"/opt/ml/processing/input/risk_tables\" if args.job_type != \"training\" else None\\n\\n        # Log input/output paths for clarity' is_hardcoded=True construction_method=None"
      ],
      "env_var_accesses": [],
      "imports": [
        "module_name='argparse' import_alias=None line_number=10 is_from_import=False imported_items=[]",
        "module_name='os' import_alias=None line_number=11 is_from_import=False imported_items=[]",
        "module_name='sys' import_alias=None line_number=12 is_from_import=False imported_items=[]",
        "module_name='pandas' import_alias='pd' line_number=13 is_from_import=False imported_items=[]",
        "module_name='numpy' import_alias='np' line_number=14 is_from_import=False imported_items=[]",
        "module_name='json' import_alias=None line_number=15 is_from_import=False imported_items=[]",
        "module_name='pickle' import_alias='pkl' line_number=16 is_from_import=False imported_items=[]",
        "module_name='pathlib' import_alias=None line_number=17 is_from_import=True imported_items=['Path']",
        "module_name='sklearn.impute' import_alias=None line_number=18 is_from_import=True imported_items=['SimpleImputer']",
        "module_name='logging' import_alias=None line_number=19 is_from_import=False imported_items=[]",
        "module_name='traceback' import_alias=None line_number=460 is_from_import=False imported_items=[]"
      ],
      "argument_definitions": [
        "argument_name='job_type' line_number=410 is_required=True has_default=False default_value=None argument_type='str' choices=['training', 'validation', 'testing', 'calibration']"
      ],
      "file_operations": [
        "file_path='<file_object>' operation_type='read' line_number=54 context='    try:\\n        with open(config_path, \"r\") as file:\\n>>>             return json.load(file)\\n    except FileNotFoundError as e:\\n        logger.error(f\"Configuration file not found at {config_path}: {str(e)}\")' mode=None method='json.load'",
        "file_path='<file_object>' operation_type='write' line_number=306 context='    bin_output_path = output_path / RISK_TABLE_FILENAME\\n    with open(bin_output_path, \"wb\") as f:\\n>>>         pkl.dump(binner.risk_tables, f)\\n    logger.info(f\"Saved binning mapping to {bin_output_path}\")\\n    logger.info(f\"This file can be used as input for non-training jobs\")' mode=None method='pickle.dump'",
        "file_path='<file_object>' operation_type='write' line_number=313 context='    hyperparams_output_path = output_path / HYPERPARAMS_FILENAME\\n    with open(hyperparams_output_path, \"w\") as f:\\n>>>         json.dump(hyperparams, f, indent=2)\\n    logger.info(f\"Saved hyperparameters to {hyperparams_output_path}\")\\n' mode=None method='json.dump'",
        "file_path='<file_object>' operation_type='read' line_number=332 context='    logger.info(f\"Loading risk tables from {risk_table_path}\")    \\n    with open(risk_table_path, \"rb\") as f:\\n>>>         risk_tables = pkl.load(f)\\n        \\n    logger.info(f\"Successfully loaded risk tables with {len(risk_tables)} mappings\")' mode=None method='pickle.load'"
      ]
    },
    "contract": {
      "entry_point": "risk_table_mapping.py",
      "inputs": {
        "data_input": {
          "path": "/opt/ml/processing/input/data"
        },
        "hyperparameters_s3_uri": {
          "path": "/opt/ml/processing/input/config"
        },
        "risk_tables": {
          "path": "/opt/ml/processing/input/risk_tables"
        }
      },
      "outputs": {
        "processed_data": {
          "path": "/opt/ml/processing/output"
        },
        "risk_tables": {
          "path": "/opt/ml/processing/output"
        }
      },
      "arguments": {},
      "environment_variables": {
        "required": [],
        "optional": {}
      },
      "description": "\n    Risk table mapping script that:\n    1. Creates risk tables for categorical features based on target variable correlation\n    2. Handles missing value imputation for numeric features\n    3. Supports both training mode (fit and transform) and inference mode (transform only)\n    4. Applies smoothing and count thresholds for robust risk estimation\n    5. Saves fitted artifacts for reuse in inference\n    \n    Input Structure:\n    - /opt/ml/processing/input/data: Data files from tabular preprocessing\n      - Training mode: train/, test/, val/ subdirectories with processed data\n      - Other modes: job_type/ subdirectory with processed data\n    - /opt/ml/processing/input/config: Configuration files\n      - config.json: Model configuration including category risk parameters\n      - metadata.csv: Variable metadata with types and imputation strategies\n      - job_type: Configuration parameter specifying job type (training, validation, testing, calibration)\n    - /opt/ml/processing/input/risk_tables: Pre-trained risk tables (for non-training modes)\n      - bin_mapping.pkl: Risk table mappings for categorical features\n      - missing_value_imputation.pkl: Imputation values for numeric features\n    \n    Output Structure:\n    - /opt/ml/processing/output/{split}/{split}_processed_data.csv: Transformed data by split\n    - /opt/ml/processing/output/bin_mapping.pkl: Risk table mappings for categorical features\n    - /opt/ml/processing/output/missing_value_imputation.pkl: Imputation values for numeric features\n    - /opt/ml/processing/output/config.pkl: Serialized configuration with metadata\n    \n    Job Types (from config):\n    - training: Fits risk tables on training data, transforms all splits\n    - validation/testing/calibration: Uses pre-trained risk tables, transforms single split\n    \n    Training Mode:\n    - Fits risk tables on training data\n    - Transforms train/test/val splits\n    - Saves risk tables and imputation models\n    \n    Non-Training Modes:\n    - Loads pre-trained risk tables and imputation models\n    - Transforms data using loaded artifacts\n    - Maintains the same output structure as training mode\n    ",
      "framework_requirements": {
        "pandas": ">=1.3.0",
        "numpy": ">=1.21.0",
        "scikit-learn": ">=1.0.0"
      }
    }
  },
  "level2": {
    "passed": true,
    "issues": [
      {
        "severity": "INFO",
        "category": "multi_variant_validation",
        "message": "Smart Specification Selection: validated against 4 variants",
        "details": {
          "contract": "risk_table_mapping",
          "variants": [
            "training",
            "testing",
            "validation",
            "calibration"
          ],
          "total_dependencies": 3,
          "total_outputs": 2,
          "contract_inputs": 3,
          "contract_outputs": 2
        },
        "recommendation": "Multi-variant validation completed successfully"
      }
    ],
    "contract": {
      "entry_point": "risk_table_mapping.py",
      "inputs": {
        "data_input": {
          "path": "/opt/ml/processing/input/data"
        },
        "hyperparameters_s3_uri": {
          "path": "/opt/ml/processing/input/config"
        },
        "risk_tables": {
          "path": "/opt/ml/processing/input/risk_tables"
        }
      },
      "outputs": {
        "processed_data": {
          "path": "/opt/ml/processing/output"
        },
        "risk_tables": {
          "path": "/opt/ml/processing/output"
        }
      },
      "arguments": {},
      "environment_variables": {
        "required": [],
        "optional": {}
      },
      "description": "\n    Risk table mapping script that:\n    1. Creates risk tables for categorical features based on target variable correlation\n    2. Handles missing value imputation for numeric features\n    3. Supports both training mode (fit and transform) and inference mode (transform only)\n    4. Applies smoothing and count thresholds for robust risk estimation\n    5. Saves fitted artifacts for reuse in inference\n    \n    Input Structure:\n    - /opt/ml/processing/input/data: Data files from tabular preprocessing\n      - Training mode: train/, test/, val/ subdirectories with processed data\n      - Other modes: job_type/ subdirectory with processed data\n    - /opt/ml/processing/input/config: Configuration files\n      - config.json: Model configuration including category risk parameters\n      - metadata.csv: Variable metadata with types and imputation strategies\n      - job_type: Configuration parameter specifying job type (training, validation, testing, calibration)\n    - /opt/ml/processing/input/risk_tables: Pre-trained risk tables (for non-training modes)\n      - bin_mapping.pkl: Risk table mappings for categorical features\n      - missing_value_imputation.pkl: Imputation values for numeric features\n    \n    Output Structure:\n    - /opt/ml/processing/output/{split}/{split}_processed_data.csv: Transformed data by split\n    - /opt/ml/processing/output/bin_mapping.pkl: Risk table mappings for categorical features\n    - /opt/ml/processing/output/missing_value_imputation.pkl: Imputation values for numeric features\n    - /opt/ml/processing/output/config.pkl: Serialized configuration with metadata\n    \n    Job Types (from config):\n    - training: Fits risk tables on training data, transforms all splits\n    - validation/testing/calibration: Uses pre-trained risk tables, transforms single split\n    \n    Training Mode:\n    - Fits risk tables on training data\n    - Transforms train/test/val splits\n    - Saves risk tables and imputation models\n    \n    Non-Training Modes:\n    - Loads pre-trained risk tables and imputation models\n    - Transforms data using loaded artifacts\n    - Maintains the same output structure as training mode\n    ",
      "framework_requirements": {
        "pandas": ">=1.3.0",
        "numpy": ">=1.21.0",
        "scikit-learn": ">=1.0.0"
      }
    },
    "specifications": {
      "risk_table_mapping_testing_spec": {
        "step_type": "RiskTableMapping_Testing",
        "node_type": "internal",
        "dependencies": [
          {
            "logical_name": "data_input",
            "dependency_type": "processing_output",
            "required": true,
            "compatible_sources": [
              "ProcessingStep",
              "TabularPreprocessing"
            ],
            "data_type": "S3Uri",
            "description": "Preprocessed testing data from tabular preprocessing step"
          },
          {
            "logical_name": "hyperparameters_s3_uri",
            "dependency_type": "hyperparameters",
            "required": false,
            "compatible_sources": [
              "ProcessingStep",
              "DataPrep",
              "DataQuality",
              "HyperparameterPrep",
              "ModelTraining",
              "FeatureEngineering",
              "ConfigurationStep"
            ],
            "data_type": "S3Uri",
            "description": "Optional external hyperparameters configuration file (will be overridden by internal generation)"
          },
          {
            "logical_name": "risk_tables",
            "dependency_type": "processing_output",
            "required": true,
            "compatible_sources": [
              "RiskTableMapping_Training"
            ],
            "data_type": "S3Uri",
            "description": "Risk tables and imputation models from training step"
          }
        ],
        "outputs": [
          {
            "logical_name": "processed_data",
            "output_type": "processing_output",
            "property_path": "properties.ProcessingOutputConfig.Outputs['processed_data'].S3Output.S3Uri",
            "data_type": "S3Uri",
            "description": "Processed testing data with risk table mappings applied"
          },
          {
            "logical_name": "risk_tables",
            "output_type": "processing_output",
            "property_path": "properties.ProcessingOutputConfig.Outputs['risk_tables'].S3Output.S3Uri",
            "data_type": "S3Uri",
            "description": "Risk tables and imputation models (passthrough from training)"
          }
        ]
      },
      "risk_table_mapping_calibration_spec": {
        "step_type": "RiskTableMapping_Calibration",
        "node_type": "internal",
        "dependencies": [
          {
            "logical_name": "data_input",
            "dependency_type": "processing_output",
            "required": true,
            "compatible_sources": [
              "ProcessingStep",
              "TabularPreprocessing"
            ],
            "data_type": "S3Uri",
            "description": "Preprocessed calibration data from tabular preprocessing step"
          },
          {
            "logical_name": "hyperparameters_s3_uri",
            "dependency_type": "hyperparameters",
            "required": false,
            "compatible_sources": [
              "ProcessingStep",
              "DataPrep",
              "DataQuality",
              "HyperparameterPrep",
              "ModelTraining",
              "FeatureEngineering",
              "ConfigurationStep"
            ],
            "data_type": "S3Uri",
            "description": "Optional external hyperparameters configuration file (will be overridden by internal generation)"
          },
          {
            "logical_name": "risk_tables",
            "dependency_type": "processing_output",
            "required": true,
            "compatible_sources": [
              "RiskTableMapping_Training"
            ],
            "data_type": "S3Uri",
            "description": "Risk tables and imputation models from training step"
          }
        ],
        "outputs": [
          {
            "logical_name": "processed_data",
            "output_type": "processing_output",
            "property_path": "properties.ProcessingOutputConfig.Outputs['processed_data'].S3Output.S3Uri",
            "data_type": "S3Uri",
            "description": "Processed calibration data with risk table mappings applied"
          },
          {
            "logical_name": "risk_tables",
            "output_type": "processing_output",
            "property_path": "properties.ProcessingOutputConfig.Outputs['risk_tables'].S3Output.S3Uri",
            "data_type": "S3Uri",
            "description": "Risk tables and imputation models (passthrough from training)"
          }
        ]
      },
      "risk_table_mapping_validation_spec": {
        "step_type": "RiskTableMapping_Validation",
        "node_type": "internal",
        "dependencies": [
          {
            "logical_name": "data_input",
            "dependency_type": "processing_output",
            "required": true,
            "compatible_sources": [
              "ProcessingStep",
              "TabularPreprocessing"
            ],
            "data_type": "S3Uri",
            "description": "Preprocessed validation data from tabular preprocessing step"
          },
          {
            "logical_name": "hyperparameters_s3_uri",
            "dependency_type": "hyperparameters",
            "required": false,
            "compatible_sources": [
              "ProcessingStep",
              "DataPrep",
              "DataQuality",
              "HyperparameterPrep",
              "ModelTraining",
              "FeatureEngineering",
              "ConfigurationStep"
            ],
            "data_type": "S3Uri",
            "description": "Optional external hyperparameters configuration file (will be overridden by internal generation)"
          },
          {
            "logical_name": "risk_tables",
            "dependency_type": "processing_output",
            "required": true,
            "compatible_sources": [
              "RiskTableMapping_Training"
            ],
            "data_type": "S3Uri",
            "description": "Risk tables and imputation models from training step"
          }
        ],
        "outputs": [
          {
            "logical_name": "processed_data",
            "output_type": "processing_output",
            "property_path": "properties.ProcessingOutputConfig.Outputs['processed_data'].S3Output.S3Uri",
            "data_type": "S3Uri",
            "description": "Processed validation data with risk table mappings applied"
          },
          {
            "logical_name": "risk_tables",
            "output_type": "processing_output",
            "property_path": "properties.ProcessingOutputConfig.Outputs['risk_tables'].S3Output.S3Uri",
            "data_type": "S3Uri",
            "description": "Risk tables and imputation models (passthrough from training)"
          }
        ]
      },
      "risk_table_mapping_training_spec": {
        "step_type": "RiskTableMapping_Training",
        "node_type": "internal",
        "dependencies": [
          {
            "logical_name": "data_input",
            "dependency_type": "processing_output",
            "required": true,
            "compatible_sources": [
              "ProcessingStep",
              "TabularPreprocessing"
            ],
            "data_type": "S3Uri",
            "description": "Preprocessed training data from tabular preprocessing step"
          },
          {
            "logical_name": "hyperparameters_s3_uri",
            "dependency_type": "hyperparameters",
            "required": false,
            "compatible_sources": [
              "ProcessingStep",
              "DataPrep",
              "DataQuality",
              "HyperparameterPrep",
              "ModelTraining",
              "FeatureEngineering",
              "ConfigurationStep"
            ],
            "data_type": "S3Uri",
            "description": "Optional external hyperparameters configuration file (will be overridden by internal generation)"
          }
        ],
        "outputs": [
          {
            "logical_name": "processed_data",
            "output_type": "processing_output",
            "property_path": "properties.ProcessingOutputConfig.Outputs['processed_data'].S3Output.S3Uri",
            "data_type": "S3Uri",
            "description": "Processed data with risk table mappings applied"
          },
          {
            "logical_name": "risk_tables",
            "output_type": "processing_output",
            "property_path": "properties.ProcessingOutputConfig.Outputs['risk_tables'].S3Output.S3Uri",
            "data_type": "S3Uri",
            "description": "Risk tables and imputation models for categorical features"
          }
        ]
      }
    },
    "unified_specification": {
      "primary_spec": {
        "step_type": "RiskTableMapping_Training",
        "node_type": "internal",
        "dependencies": [
          {
            "logical_name": "data_input",
            "dependency_type": "processing_output",
            "required": true,
            "compatible_sources": [
              "ProcessingStep",
              "TabularPreprocessing"
            ],
            "data_type": "S3Uri",
            "description": "Preprocessed training data from tabular preprocessing step"
          },
          {
            "logical_name": "hyperparameters_s3_uri",
            "dependency_type": "hyperparameters",
            "required": false,
            "compatible_sources": [
              "ProcessingStep",
              "DataPrep",
              "DataQuality",
              "HyperparameterPrep",
              "ModelTraining",
              "FeatureEngineering",
              "ConfigurationStep"
            ],
            "data_type": "S3Uri",
            "description": "Optional external hyperparameters configuration file (will be overridden by internal generation)"
          }
        ],
        "outputs": [
          {
            "logical_name": "processed_data",
            "output_type": "processing_output",
            "property_path": "properties.ProcessingOutputConfig.Outputs['processed_data'].S3Output.S3Uri",
            "data_type": "S3Uri",
            "description": "Processed data with risk table mappings applied"
          },
          {
            "logical_name": "risk_tables",
            "output_type": "processing_output",
            "property_path": "properties.ProcessingOutputConfig.Outputs['risk_tables'].S3Output.S3Uri",
            "data_type": "S3Uri",
            "description": "Risk tables and imputation models for categorical features"
          }
        ]
      },
      "variants": {
        "training": {
          "step_type": "RiskTableMapping_Training",
          "node_type": "internal",
          "dependencies": [
            {
              "logical_name": "data_input",
              "dependency_type": "processing_output",
              "required": true,
              "compatible_sources": [
                "ProcessingStep",
                "TabularPreprocessing"
              ],
              "data_type": "S3Uri",
              "description": "Preprocessed training data from tabular preprocessing step"
            },
            {
              "logical_name": "hyperparameters_s3_uri",
              "dependency_type": "hyperparameters",
              "required": false,
              "compatible_sources": [
                "ProcessingStep",
                "DataPrep",
                "DataQuality",
                "HyperparameterPrep",
                "ModelTraining",
                "FeatureEngineering",
                "ConfigurationStep"
              ],
              "data_type": "S3Uri",
              "description": "Optional external hyperparameters configuration file (will be overridden by internal generation)"
            }
          ],
          "outputs": [
            {
              "logical_name": "processed_data",
              "output_type": "processing_output",
              "property_path": "properties.ProcessingOutputConfig.Outputs['processed_data'].S3Output.S3Uri",
              "data_type": "S3Uri",
              "description": "Processed data with risk table mappings applied"
            },
            {
              "logical_name": "risk_tables",
              "output_type": "processing_output",
              "property_path": "properties.ProcessingOutputConfig.Outputs['risk_tables'].S3Output.S3Uri",
              "data_type": "S3Uri",
              "description": "Risk tables and imputation models for categorical features"
            }
          ]
        },
        "testing": {
          "step_type": "RiskTableMapping_Testing",
          "node_type": "internal",
          "dependencies": [
            {
              "logical_name": "data_input",
              "dependency_type": "processing_output",
              "required": true,
              "compatible_sources": [
                "ProcessingStep",
                "TabularPreprocessing"
              ],
              "data_type": "S3Uri",
              "description": "Preprocessed testing data from tabular preprocessing step"
            },
            {
              "logical_name": "hyperparameters_s3_uri",
              "dependency_type": "hyperparameters",
              "required": false,
              "compatible_sources": [
                "ProcessingStep",
                "DataPrep",
                "DataQuality",
                "HyperparameterPrep",
                "ModelTraining",
                "FeatureEngineering",
                "ConfigurationStep"
              ],
              "data_type": "S3Uri",
              "description": "Optional external hyperparameters configuration file (will be overridden by internal generation)"
            },
            {
              "logical_name": "risk_tables",
              "dependency_type": "processing_output",
              "required": true,
              "compatible_sources": [
                "RiskTableMapping_Training"
              ],
              "data_type": "S3Uri",
              "description": "Risk tables and imputation models from training step"
            }
          ],
          "outputs": [
            {
              "logical_name": "processed_data",
              "output_type": "processing_output",
              "property_path": "properties.ProcessingOutputConfig.Outputs['processed_data'].S3Output.S3Uri",
              "data_type": "S3Uri",
              "description": "Processed testing data with risk table mappings applied"
            },
            {
              "logical_name": "risk_tables",
              "output_type": "processing_output",
              "property_path": "properties.ProcessingOutputConfig.Outputs['risk_tables'].S3Output.S3Uri",
              "data_type": "S3Uri",
              "description": "Risk tables and imputation models (passthrough from training)"
            }
          ]
        },
        "validation": {
          "step_type": "RiskTableMapping_Validation",
          "node_type": "internal",
          "dependencies": [
            {
              "logical_name": "data_input",
              "dependency_type": "processing_output",
              "required": true,
              "compatible_sources": [
                "ProcessingStep",
                "TabularPreprocessing"
              ],
              "data_type": "S3Uri",
              "description": "Preprocessed validation data from tabular preprocessing step"
            },
            {
              "logical_name": "hyperparameters_s3_uri",
              "dependency_type": "hyperparameters",
              "required": false,
              "compatible_sources": [
                "ProcessingStep",
                "DataPrep",
                "DataQuality",
                "HyperparameterPrep",
                "ModelTraining",
                "FeatureEngineering",
                "ConfigurationStep"
              ],
              "data_type": "S3Uri",
              "description": "Optional external hyperparameters configuration file (will be overridden by internal generation)"
            },
            {
              "logical_name": "risk_tables",
              "dependency_type": "processing_output",
              "required": true,
              "compatible_sources": [
                "RiskTableMapping_Training"
              ],
              "data_type": "S3Uri",
              "description": "Risk tables and imputation models from training step"
            }
          ],
          "outputs": [
            {
              "logical_name": "processed_data",
              "output_type": "processing_output",
              "property_path": "properties.ProcessingOutputConfig.Outputs['processed_data'].S3Output.S3Uri",
              "data_type": "S3Uri",
              "description": "Processed validation data with risk table mappings applied"
            },
            {
              "logical_name": "risk_tables",
              "output_type": "processing_output",
              "property_path": "properties.ProcessingOutputConfig.Outputs['risk_tables'].S3Output.S3Uri",
              "data_type": "S3Uri",
              "description": "Risk tables and imputation models (passthrough from training)"
            }
          ]
        },
        "calibration": {
          "step_type": "RiskTableMapping_Calibration",
          "node_type": "internal",
          "dependencies": [
            {
              "logical_name": "data_input",
              "dependency_type": "processing_output",
              "required": true,
              "compatible_sources": [
                "ProcessingStep",
                "TabularPreprocessing"
              ],
              "data_type": "S3Uri",
              "description": "Preprocessed calibration data from tabular preprocessing step"
            },
            {
              "logical_name": "hyperparameters_s3_uri",
              "dependency_type": "hyperparameters",
              "required": false,
              "compatible_sources": [
                "ProcessingStep",
                "DataPrep",
                "DataQuality",
                "HyperparameterPrep",
                "ModelTraining",
                "FeatureEngineering",
                "ConfigurationStep"
              ],
              "data_type": "S3Uri",
              "description": "Optional external hyperparameters configuration file (will be overridden by internal generation)"
            },
            {
              "logical_name": "risk_tables",
              "dependency_type": "processing_output",
              "required": true,
              "compatible_sources": [
                "RiskTableMapping_Training"
              ],
              "data_type": "S3Uri",
              "description": "Risk tables and imputation models from training step"
            }
          ],
          "outputs": [
            {
              "logical_name": "processed_data",
              "output_type": "processing_output",
              "property_path": "properties.ProcessingOutputConfig.Outputs['processed_data'].S3Output.S3Uri",
              "data_type": "S3Uri",
              "description": "Processed calibration data with risk table mappings applied"
            },
            {
              "logical_name": "risk_tables",
              "output_type": "processing_output",
              "property_path": "properties.ProcessingOutputConfig.Outputs['risk_tables'].S3Output.S3Uri",
              "data_type": "S3Uri",
              "description": "Risk tables and imputation models (passthrough from training)"
            }
          ]
        }
      },
      "unified_dependencies": {
        "data_input": {
          "logical_name": "data_input",
          "dependency_type": "processing_output",
          "required": true,
          "compatible_sources": [
            "ProcessingStep",
            "TabularPreprocessing"
          ],
          "data_type": "S3Uri",
          "description": "Preprocessed calibration data from tabular preprocessing step"
        },
        "hyperparameters_s3_uri": {
          "logical_name": "hyperparameters_s3_uri",
          "dependency_type": "hyperparameters",
          "required": false,
          "compatible_sources": [
            "ProcessingStep",
            "DataPrep",
            "DataQuality",
            "HyperparameterPrep",
            "ModelTraining",
            "FeatureEngineering",
            "ConfigurationStep"
          ],
          "data_type": "S3Uri",
          "description": "Optional external hyperparameters configuration file (will be overridden by internal generation)"
        },
        "risk_tables": {
          "logical_name": "risk_tables",
          "dependency_type": "processing_output",
          "required": true,
          "compatible_sources": [
            "RiskTableMapping_Training"
          ],
          "data_type": "S3Uri",
          "description": "Risk tables and imputation models from training step"
        }
      },
      "unified_outputs": {
        "processed_data": {
          "logical_name": "processed_data",
          "output_type": "processing_output",
          "property_path": "properties.ProcessingOutputConfig.Outputs['processed_data'].S3Output.S3Uri",
          "data_type": "S3Uri",
          "description": "Processed calibration data with risk table mappings applied"
        },
        "risk_tables": {
          "logical_name": "risk_tables",
          "output_type": "processing_output",
          "property_path": "properties.ProcessingOutputConfig.Outputs['risk_tables'].S3Output.S3Uri",
          "data_type": "S3Uri",
          "description": "Risk tables and imputation models (passthrough from training)"
        }
      },
      "dependency_sources": {
        "data_input": [
          "training",
          "testing",
          "validation",
          "calibration"
        ],
        "hyperparameters_s3_uri": [
          "training",
          "testing",
          "validation",
          "calibration"
        ],
        "risk_tables": [
          "testing",
          "validation",
          "calibration"
        ]
      },
      "output_sources": {
        "processed_data": [
          "training",
          "testing",
          "validation",
          "calibration"
        ],
        "risk_tables": [
          "training",
          "testing",
          "validation",
          "calibration"
        ]
      },
      "variant_count": 4
    }
  },
  "level3": {
    "passed": true,
    "issues": [
      {
        "severity": "WARNING",
        "category": "dependency_compatibility",
        "message": "Dependency hyperparameters_s3_uri has low compatibility score: 0.420",
        "details": {
          "logical_name": "hyperparameters_s3_uri",
          "specification": "risk_table_mapping",
          "best_match": {
            "provider": "BatchTransform",
            "output": "transform_output",
            "score": 0.4197368421052632
          },
          "required": false,
          "threshold_info": {
            "mode": "relaxed",
            "thresholds": {
              "pass": "\u2265 0.6",
              "warning": "0.4 - 0.59",
              "error": "0.2 - 0.39",
              "critical": "< 0.2"
            },
            "resolution_threshold": 0.5,
            "description": "Relaxed validation allowing reasonable compatibility matches"
          },
          "score_breakdown": {
            "type_compatibility": 0.2,
            "data_type_compatibility": 0.2,
            "semantic_similarity": 0.019736842105263157,
            "exact_match_bonus": 0.0,
            "source_compatibility": 0.0,
            "keyword_matching": 0.0
          },
          "all_candidates": [
            {
              "provider": "BatchTransform",
              "output": "transform_output",
              "score": 0.4197368421052632
            }
          ]
        },
        "recommendation": "Consider renaming 'hyperparameters_s3_uri' or adding aliases to improve semantic matching; Add 'BatchTransform' to compatible_sources for hyperparameters_s3_uri"
      }
    ],
    "specification": {
      "step_type": "RiskTableMapping_Testing",
      "node_type": "internal",
      "dependencies": [
        {
          "logical_name": "data_input",
          "dependency_type": "processing_output",
          "required": true,
          "compatible_sources": [
            "ProcessingStep",
            "TabularPreprocessing"
          ],
          "data_type": "S3Uri",
          "description": "Preprocessed testing data from tabular preprocessing step"
        },
        {
          "logical_name": "hyperparameters_s3_uri",
          "dependency_type": "hyperparameters",
          "required": false,
          "compatible_sources": [
            "ProcessingStep",
            "DataPrep",
            "DataQuality",
            "HyperparameterPrep",
            "ModelTraining",
            "FeatureEngineering",
            "ConfigurationStep"
          ],
          "data_type": "S3Uri",
          "description": "Optional external hyperparameters configuration file (will be overridden by internal generation)"
        },
        {
          "logical_name": "risk_tables",
          "dependency_type": "processing_output",
          "required": true,
          "compatible_sources": [
            "RiskTableMapping_Training"
          ],
          "data_type": "S3Uri",
          "description": "Risk tables and imputation models from training step"
        }
      ],
      "outputs": [
        {
          "logical_name": "processed_data",
          "output_type": "processing_output",
          "property_path": "properties.ProcessingOutputConfig.Outputs['processed_data'].S3Output.S3Uri",
          "data_type": "S3Uri",
          "description": "Processed testing data with risk table mappings applied"
        },
        {
          "logical_name": "risk_tables",
          "output_type": "processing_output",
          "property_path": "properties.ProcessingOutputConfig.Outputs['risk_tables'].S3Output.S3Uri",
          "data_type": "S3Uri",
          "description": "Risk tables and imputation models (passthrough from training)"
        }
      ]
    }
  },
  "level4": {
    "passed": true,
    "issues": [],
    "builder_analysis": {
      "config_accesses": [
        {
          "field_name": "job_type",
          "line_number": 74
        }
      ],
      "validation_calls": [],
      "default_assignments": [],
      "class_definitions": [
        {
          "class_name": "RiskTableMappingStepBuilder",
          "line_number": 37
        }
      ],
      "method_definitions": [
        {
          "method_name": "__init__",
          "line_number": 46
        },
        {
          "method_name": "validate_configuration",
          "line_number": 107
        },
        {
          "method_name": "_create_processor",
          "line_number": 138
        },
        {
          "method_name": "_get_environment_variables",
          "line_number": 158
        },
        {
          "method_name": "_prepare_hyperparameters_file",
          "line_number": 179
        },
        {
          "method_name": "_get_inputs",
          "line_number": 276
        },
        {
          "method_name": "_get_outputs",
          "line_number": 372
        },
        {
          "method_name": "_get_job_arguments",
          "line_number": 424
        },
        {
          "method_name": "create_step",
          "line_number": 440
        }
      ]
    },
    "config_analysis": {
      "class_name": "RiskTableMappingConfig",
      "fields": {
        "processing_entry_point": {
          "type": "<class 'str'>",
          "required": false
        },
        "job_type": {
          "type": "<class 'str'>",
          "required": false
        },
        "cat_field_list": {
          "type": "typing.List[str]",
          "required": false
        },
        "label_name": {
          "type": "<class 'str'>",
          "required": false
        },
        "smooth_factor": {
          "type": "<class 'float'>",
          "required": false
        },
        "count_threshold": {
          "type": "<class 'int'>",
          "required": false
        },
        "hyperparameters_s3_uri": {
          "type": "typing.Optional[str]",
          "required": false
        },
        "hyperparameters": {
          "type": "typing.Optional[src.cursus.core.base.hyperparameters_base.ModelHyperparameters]",
          "required": false
        }
      },
      "required_fields": [],
      "optional_fields": [
        "cat_field_list",
        "count_threshold",
        "hyperparameters",
        "hyperparameters_s3_uri",
        "job_type",
        "label_name",
        "processing_entry_point",
        "smooth_factor"
      ],
      "default_values": {
        "aws_region": "<property>",
        "effective_instance_type": "<property>",
        "effective_source_dir": "<property>",
        "model_computed_fields": {},
        "model_config": {
          "arbitrary_types_allowed": true,
          "extra": "allow",
          "protected_namespaces": [],
          "validate_assignment": true
        },
        "model_extra": "<property>",
        "model_fields": {
          "author": "annotation=str required=True description='Author or owner of the pipeline.'",
          "bucket": "annotation=str required=True description='S3 bucket name for pipeline artifacts and data.'",
          "role": "annotation=str required=True description='IAM role for pipeline execution.'",
          "region": "annotation=str required=True description='Custom region code (NA, EU, FE) for internal logic.'",
          "service_name": "annotation=str required=True description='Service name for the pipeline.'",
          "pipeline_version": "annotation=str required=True description='Version string for the SageMaker Pipeline.'",
          "model_class": "annotation=str required=False default='xgboost' description='Model class (e.g., XGBoost, PyTorch).'",
          "current_date": "annotation=str required=False default_factory=<lambda> description='Current date, typically used for versioning or pathing.'",
          "framework_version": "annotation=str required=False default='2.1.0' description='Default framework version (e.g., PyTorch).'",
          "py_version": "annotation=str required=False default='py310' description='Default Python version.'",
          "source_dir": "annotation=Union[str, NoneType] required=False default=None description='Common source directory for scripts if applicable. Can be overridden by step configs.'",
          "processing_instance_count": "annotation=int required=False default=1 description='Instance count for processing jobs' metadata=[Ge(ge=1), Le(le=10)]",
          "processing_volume_size": "annotation=int required=False default=500 description='Volume size for processing jobs in GB' metadata=[Ge(ge=10), Le(le=1000)]",
          "processing_instance_type_large": "annotation=str required=False default='ml.m5.4xlarge' description='Large instance type for processing step.'",
          "processing_instance_type_small": "annotation=str required=False default='ml.m5.2xlarge' description='Small instance type for processing step.'",
          "use_large_processing_instance": "annotation=bool required=False default=False description='Set to True to use large instance type, False for small instance type.'",
          "processing_source_dir": "annotation=Union[str, NoneType] required=False default=None description='Source directory for processing scripts. Falls back to base source_dir if not provided.'",
          "processing_entry_point": "annotation=str required=False default='risk_table_mapping.py' description='Script for risk table mapping'",
          "processing_script_arguments": "annotation=Union[List[str], NoneType] required=False default=None description='Optional arguments for the processing script.'",
          "processing_framework_version": "annotation=str required=False default='1.2-1' description=\"Version of the scikit-learn framework to use in SageMaker Processing. Format: '<sklearn-version>-<build-number>'\"",
          "job_type": "annotation=str required=False default='training' description=\"Type of job to perform. One of 'training', 'validation', 'testing', 'calibration'\"",
          "cat_field_list": "annotation=List[str] required=False default=[] description='List of categorical fields to apply risk table mapping to'",
          "label_name": "annotation=str required=False default='target' description='Name of the target/label column'",
          "smooth_factor": "annotation=float required=False default=0.01 description='Smoothing factor for risk table calculation'",
          "count_threshold": "annotation=int required=False default=5 description='Minimum count threshold for risk table calculation'",
          "hyperparameters_s3_uri": "annotation=Union[str, NoneType] required=False default=None description='S3 URI prefix for uploading hyperparameters.json'",
          "hyperparameters": "annotation=Union[ModelHyperparameters, NoneType] required=False default=None description='Optional model hyperparameters for advanced configuration'"
        },
        "model_fields_set": "<property>",
        "pipeline_description": "<property>",
        "pipeline_name": "<property>",
        "pipeline_s3_loc": "<property>",
        "script_contract": "<property>",
        "script_path": "<property>"
      }
    }
  },
  "overall_status": "PASSING",
  "metadata": {
    "script_path": "/Users/tianpeixie/github_workspace/cursus/src/cursus/steps/scripts/risk_table_mapping.py",
    "contract_mapping": "risk_table_mapping_contract",
    "validation_timestamp": "2025-08-11T20:40:42.439083",
    "validator_version": "1.0.0"
  }
}